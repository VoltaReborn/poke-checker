<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pok√©Type Checker</title>
<link rel="manifest" href="manifest.json" />
<style>
:root {
  --bg:#0a1224;
  --card:#15254b;
  --accent:#ffb400;
  --text:#fff;
}
/* Base */
* { box-sizing: border-box; }
body { margin:0; font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--text); }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 16px; background:var(--card); }
h1 { font-size:1.1rem; margin:0; }
#themeToggle { background:none; border:none; cursor:pointer; color:var(--accent); font-size:1.2rem; }

/* Tabs */
#modeTabs { display:flex; justify-content:center; margin:10px 0; }
.tab {
  padding:8px 16px; background:var(--card); color:var(--text);
  border:1px solid var(--accent); border-radius:8px; margin:0 5px; cursor:pointer;
}
.tab.active { background:var(--accent); color:#000; }

/* Sections & Cards */
.section { display:none; padding:10px; }
.section.active { display:block; }
.resultCard {
  background:var(--card); margin:8px 0; padding:10px;
  border:1px solid var(--accent); border-radius:8px; animation:fade .3s;
}
@keyframes fade { from{opacity:0;} to{opacity:1;} }
.type-badge {
  display:inline-block; border-radius:12px; padding:4px 8px; margin:2px;
  color:#fff; font-weight:600; font-size:.9rem;
}

/* Controls */
#typeControls, #pokeControls {
  display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:10px;
}
select, input {
  width:90%; max-width:360px; font-size:1rem; padding:12px; border-radius:8px;
  border:1px solid var(--accent); background:var(--card); color:var(--text); text-align:center;
}
select:focus, input:focus { outline:none; box-shadow:0 0 4px var(--accent); }
#typeButtons { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
button {
  font-size:1rem; padding:10px 14px; border-radius:8px; border:1px solid var(--accent);
  background:var(--card); color:var(--text); cursor:pointer;
}
button:hover { background:var(--accent); color:#000; }
#resetBtn, #pokeResetBtn { background:none; border:1px solid var(--accent); color:var(--accent); }
#resetBtn:hover, #pokeResetBtn:hover { background:var(--accent); color:#000; }

/* Divider */
.section-divider {
  margin:16px 0; text-align:center; font-weight:bold; color:var(--accent); position:relative;
}
.section-divider::before, .section-divider::after {
  content:""; position:absolute; top:50%; width:40%; height:1px;
  background:linear-gradient(to right,transparent,var(--accent),transparent);
}
.section-divider::before { left:0; } .section-divider::after { right:0; }

/* Previews */
#typePreview, #pokeTypePreview { display:flex; justify-content:center; gap:6px; }
.type-preview-badge { display:inline-block; width:60px; height:18px; border-radius:10px; }

/* Pok√©mon checker specifics */
#pokeImg { width:140px; display:block; margin:10px auto; }
#pokeList div { padding:6px 10px; background:var(--card); border:1px solid var(--accent);
  border-radius:8px; margin:2px 0; }
#pokeList div:hover { background:var(--accent); color:#000; }

/* Evolution UI */
#pokeButtonsRow { display:flex; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap; }
#evoCard { background:var(--card); border:1px solid var(--accent); border-radius:12px; padding:10px; margin:10px 0; }
.evo-line { display:flex; align-items:center; justify-content:center; flex-wrap:wrap; gap:10px; }
.evo-node { text-align:center; cursor:pointer; }
.evo-node img { width:72px; height:72px; object-fit:contain; display:block; margin:0 auto 4px; }
.evo-name { font-size:.85rem; }
.evo-arrow { color:var(--accent); font-weight:700; display:flex; align-items:center; gap:6px; }
.evo-method { font-size:.75rem; opacity:.9; }

/* Responsive layout */
@media (min-width: 700px) {
  main { display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:10px; }
}

@keyframes pokePulse {
  0%   { filter: drop-shadow(0 0 6px rgba(255,180,0,0.35)); }
  50%  { filter: drop-shadow(0 0 18px rgba(255,180,0,0.75)); }
  100% { filter: drop-shadow(0 0 6px rgba(255,180,0,0.35)); }
}

/* Default: subtle placeholder (smaller, semi-transparent) */
#pokeImg{
  display:block;
  margin:10px auto;
  width:100px;
  opacity:0.55;
  transition: opacity .45s ease, width .25s ease;
}

/* Pulsing amber glow state (when showing Pok√© Ball icon) */
#pokeImg.pulse{
  animation: pokePulse 2.4s ease-in-out infinite;
}

/* Active Pok√©mon artwork (larger, fully opaque, no pulse) */
#pokeImg.active{
  width:140px;
  opacity:1;
  animation:none;
  filter:none;
}
</style>
</head>
<body>
<header>
  <h1>Pok√©Type Checker</h1>
  <button id="themeToggle" title="Toggle Theme">üé®</button>
</header>

<div id="modeTabs">
  <div class="tab active" data-target="typeSection">Type Checker</div>
  <div class="tab" data-target="pokeSection">Pok√©mon Checker</div>
</div>

<main>
  <!-- TYPE SECTION (both perspectives) -->
  <section id="typeSection" class="section active">
    <div id="typeControls">
      <label>Type 1:
        <select id="type1"></select>
      </label>
      <label>Type 2:
        <select id="type2">
          <option value="">(none)</option>
        </select>
      </label>
      <div id="typePreview"></div>
    </div>
    <div id="typeButtons">
      <button id="checkBtn">Check Effectiveness</button>
      <button id="resetBtn">Reset Types</button>
    </div>
    <div id="typeResults"></div>
  </section>

  <!-- POK√âMON SECTION (defense-only + evolution info) -->
  <section id="pokeSection" class="section">
    <div id="pokeControls">
      <input id="pokeSearch" placeholder="Search Pok√©mon name..." autocomplete="off" />
      <div id="pokeList"></div>
      <img id="pokeImg"
        src="icon-192.png"
        alt="Pok√© Ball placeholder"
        class="pulse">
      <div id="pokeTypes"></div>
      <div id="pokeButtonsRow">
        <button id="evoToggleBtn">Show Evolution Info</button>
        <button id="pokeResetBtn">Reset Pok√©mon</button>
      </div>
      <div id="evoCard" hidden>
        <div id="evoTitle" style="font-weight:700;margin-bottom:6px;">Evolution</div>
        <div id="evoContent"></div>
      </div>
    </div>
    <div id="pokeResults"></div>
  </section>
</main>

<script>
/* ---------- VERSION CONTROL & REFRESH BUTTON ---------- */
function showPokemonImage(url){
  const img = document.getElementById("pokeImg");
  img.src = url;
  img.classList.add("active");
  img.classList.remove("pulse");
}

function hidePokemonImage(){
  const img = document.getElementById("pokeImg");
  img.src = "icon-192.png";
  img.classList.remove("active");
  img.classList.add("pulse");
}
const appVersion = "1.4.0";
const refreshButton = document.createElement("button");
refreshButton.textContent = "üîÑ Refresh App";
Object.assign(refreshButton.style, {
  position:"fixed", bottom:"10px", right:"10px", padding:"6px 10px",
  fontSize:"0.9rem", borderRadius:"8px", border:"1px solid var(--accent)",
  background:"var(--card)", color:"var(--accent)", zIndex:"9999"
});
refreshButton.onclick = () => {
  localStorage.removeItem("poketype-version");
  if ('caches' in window) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
  location.reload(true);
};
document.addEventListener("DOMContentLoaded", () => document.body.append(refreshButton));
const storedVersion = localStorage.getItem("poketype-version");
if (storedVersion && storedVersion !== appVersion) {
  if ('caches' in window) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
  localStorage.setItem("poketype-version", appVersion);
  location.reload(true);
} else if (!storedVersion) {
  localStorage.setItem("poketype-version", appVersion);
}

/* ---------- TYPE DATA ---------- */
const typeChart={
Normal:{weak:["Fighting"],resist:[],immune:["Ghost"]},
Fire:{weak:["Water","Ground","Rock"],resist:["Fire","Grass","Ice","Bug","Steel","Fairy"],immune:[]},
Water:{weak:["Electric","Grass"],resist:["Fire","Water","Ice","Steel"],immune:[]},
Electric:{weak:["Ground"],resist:["Electric","Flying","Steel"],immune:[]},
Grass:{weak:["Fire","Ice","Poison","Flying","Bug"],resist:["Water","Electric","Grass","Ground"],immune:[]},
Ice:{weak:["Fire","Fighting","Rock","Steel"],resist:["Ice"],immune:[]},
Fighting:{weak:["Flying","Psychic","Fairy"],resist:["Bug","Rock","Dark"],immune:[]},
Poison:{weak:["Ground","Psychic"],resist:["Grass","Fighting","Poison","Bug","Fairy"],immune:[]},
Ground:{weak:["Water","Grass","Ice"],resist:["Poison","Rock"],immune:["Electric"]},
Flying:{weak:["Electric","Ice","Rock"],resist:["Grass","Fighting","Bug"],immune:["Ground"]},
Psychic:{weak:["Bug","Ghost","Dark"],resist:["Fighting","Psychic"],immune:[]},
Bug:{weak:["Fire","Flying","Rock"],resist:["Grass","Fighting","Ground"],immune:[]},
Rock:{weak:["Water","Grass","Fighting","Ground","Steel"],resist:["Normal","Fire","Poison","Flying"],immune:[]},
Ghost:{weak:["Ghost","Dark"],resist:["Poison","Bug"],immune:["Normal","Fighting"]},
Dragon:{weak:["Ice","Dragon","Fairy"],resist:["Fire","Water","Electric","Grass"],immune:[]},
Dark:{weak:["Fighting","Bug","Fairy"],resist:["Ghost","Dark"],immune:["Psychic"]},
Steel:{weak:["Fire","Fighting","Ground"],resist:["Normal","Grass","Ice","Flying","Psychic","Bug","Rock","Dragon","Steel","Fairy"],immune:["Poison"]},
Fairy:{weak:["Poison","Steel"],resist:["Fighting","Bug","Dark"],immune:["Dragon"]}
};
const typeColors={Normal:"#A8A77A",Fire:"#EE8130",Water:"#6390F0",Electric:"#F7D02C",Grass:"#7AC74C",
Ice:"#96D9D6",Fighting:"#C22E28",Poison:"#A33EA1",Ground:"#E2BF65",Flying:"#A98FF3",
Psychic:"#F95587",Bug:"#A6B91A",Rock:"#B6A136",Ghost:"#735797",Dragon:"#6F35FC",
Dark:"#705746",Steel:"#B7B7CE",Fairy:"#D685AD"};
const types=Object.keys(typeChart);
const t1=document.getElementById("type1"),t2=document.getElementById("type2");

/* Fill dropdowns (desktop shows colored options; mobile shows preview bars) */
function addTypeOptions(sel){
  types.forEach(t=>{
    const opt=new Option(t,t);
    opt.style.background=typeColors[t];
    opt.style.color="#fff";
    opt.style.fontWeight="600";
    sel.add(opt);
  });
}
addTypeOptions(t1); addTypeOptions(t2);

/* Tabs */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.target).classList.add("active");
  };
});

/* Theme toggle */
let pokemonTheme=false;
document.getElementById("themeToggle").onclick=()=>{
  pokemonTheme=!pokemonTheme;
  document.documentElement.style.setProperty("--bg",pokemonTheme?"#fff":"#0a1224");
  document.documentElement.style.setProperty("--card",pokemonTheme?"#f4f4f4":"#15254b");
  document.documentElement.style.setProperty("--text",pokemonTheme?"#000":"#fff");
};

/* Preview bars under selects (mobile-friendly) */
function updateTypePreview(){
  const preview=document.getElementById("typePreview");
  preview.innerHTML="";
  [t1.value,t2.value].filter(Boolean).forEach(t=>{
    const div=document.createElement("div");
    div.className="type-preview-badge";
    div.style.background=typeColors[t];
    preview.append(div);
  });
}
t1.onchange=updateTypePreview; t2.onchange=updateTypePreview;

/* Reset types */
document.getElementById("resetBtn").onclick=()=>{
  t1.selectedIndex=0; t2.selectedIndex=0;
  document.getElementById("typeResults").innerHTML="";
  updateTypePreview();
};

/* Calculations */
function calcOffense(selTypes){
  const all=Object.keys(typeChart); const result={strong:[],weak:[],immune:[]};
  all.forEach(def=>{
    let mult=1;
    selTypes.forEach(atk=>{
      if(typeChart[def].weak.includes(atk)) mult*=2;
      if(typeChart[def].resist.includes(atk)) mult*=0.5;
      if(typeChart[def].immune.includes(atk)) mult*=0;
    });
    if(mult>1) result.strong.push({type:def,mult});
    if(mult<1&&mult>0) result.weak.push({type:def,mult});
    if(mult===0) result.immune.push({type:def,mult});
  });
  return result;
}
function calcDefense(selTypes){
  const all=Object.keys(typeChart); const result={strong:[],weak:[],immune:[]};
  all.forEach(atk=>{
    let mult=1;
    selTypes.forEach(def=>{
      if(typeChart[def].weak.includes(atk)) mult*=2;
      if(typeChart[def].resist.includes(atk)) mult*=0.5;
      if(typeChart[def].immune.includes(atk)) mult*=0;
    });
    if(mult>1) result.strong.push({type:atk,mult});
    if(mult<1&&mult>0) result.weak.push({type:atk,mult});
    if(mult===0) result.immune.push({type:atk,mult});
  });
  return result;
}

/* Renderers */
function renderBoth(container,label,defense,offense){
  container.innerHTML="";
  const make=(l,d)=>{
    if(!d.length) return "";
    let html=`<div class='resultCard'><strong>${l}</strong><br>`;
    d.forEach(o=>{ html+=`<span class='type-badge' style='background:${typeColors[o.type]}'>${o.type} √ó${o.mult}</span>`; });
    return html+"</div>";
  };
  container.innerHTML+=make(`Strong Against ${label}`,defense.strong);
  container.innerHTML+=make(`Not Very Effective Against ${label}`,defense.weak);
  container.innerHTML+=make(`No Effect Against ${label}`,defense.immune);
  container.innerHTML+=`<div class='section-divider'>Counter Perspective ‚ñº</div>`;
  container.innerHTML+=make(`${label} is Strong Against`,offense.strong);
  container.innerHTML+=make(`${label} is Weak Against`,offense.weak);
  container.innerHTML+=make(`${label} has No Effect On`,offense.immune);
}
function renderDefenseOnly(container,label,defense){
  container.innerHTML="";
  const make=(l,d)=>{
    if(!d.length) return "";
    let html=`<div class='resultCard'><strong>${l}</strong><br>`;
    d.forEach(o=>{ html+=`<span class='type-badge' style='background:${typeColors[o.type]}'>${o.type} √ó${o.mult}</span>`; });
    return html+"</div>";
  };
  container.innerHTML+=make(`Strong Against ${label}`,defense.strong);
  container.innerHTML+=make(`Not Very Effective Against ${label}`,defense.weak);
  container.innerHTML+=make(`No Effect Against ${label}`,defense.immune);
}

/* Type check */
document.getElementById("checkBtn").onclick=()=>{
  const sel=[t1.value,t2.value].filter(Boolean);
  if(!sel.length) return;
  const label=sel.join(" / ");
  const def=calcDefense(sel), off=calcOffense(sel);
  renderBoth(document.getElementById("typeResults"),label,def,off);
};

/* Pok√©mon search + images */
const pokeInput=document.getElementById("pokeSearch"),
      pokeList=document.getElementById("pokeList");
let pokedata=[];
async function loadData(){
  if(pokedata.length) return;
  const res=await fetch("https://raw.githubusercontent.com/fanzeyi/pokemon.json/master/pokedex.json");
  const list=await res.json();
  pokedata=list.map(p=>({name:p.name.english,types:p.type,id:p.id}));
}
pokeInput.addEventListener("input",async()=>{
  await loadData();
  const q=pokeInput.value.toLowerCase();
  pokeList.innerHTML="";
  if(!q) return;
  pokedata.filter(p=>p.name.toLowerCase().includes(q)).slice(0,10).forEach(p=>{
    const div=document.createElement("div");
    div.textContent=p.name; div.style.cursor="pointer";
    div.onclick=()=>selectPoke(p);
    pokeList.append(div);
  });
});

/* Evolution via Pok√©API */
async function fetchSpeciesById(id){
  const res=await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}/`);
  if(!res.ok) throw new Error("species fetch failed");
  return res.json();
}
async function fetchEvolutionChain(url){
  const res=await fetch(url);
  if(!res.ok) throw new Error("evo chain fetch failed");
  return res.json();
}
function extractIdFromUrl(url){
  const m=url.match(/\/(\d+)\/?$/); return m?parseInt(m[1],10):null;
}
function buildPaths(chain){
  const paths=[];
  function dfs(node, path){
    const id=extractIdFromUrl(node.species.url);
    const current=[...path, { name:node.species.name, id, details:node.evolution_details||[] }];
    if(!node.evolves_to || node.evolves_to.length===0){ paths.push(current); return; }
    node.evolves_to.forEach(next=>dfs(next, current));
  }
  dfs(chain, []);
  return paths;
}
function formatMethod(details){
  if(!details || !details[0]) return "";
  const d=details[0];
  if(d.trigger && d.trigger.name==="trade") return "Trade";
  if(d.trigger && d.trigger.name==="use-item" && d.item) return `Use ${title(d.item.name)}`;
  if(d.trigger && d.trigger.name==="level-up"){
    let bits=[];
    if(d.min_level!=null) bits.push(`Lv ${d.min_level}`);
    if(d.time_of_day) bits.push(title(d.time_of_day));
    if(d.min_happiness!=null) bits.push(`Happiness ${d.min_happiness}+`);
    if(d.known_move_type) bits.push(`${title(d.known_move_type.name)} move`);
    if(d.gender===1) bits.push("‚ôÄ"); else if(d.gender===2) bits.push("‚ôÇ");
    if(d.location) bits.push(`@ ${title(d.location.name)}`);
    return bits.join(" ¬∑ ") || "Level up";
  }
  return title(d.trigger?.name||"");
}
function title(s){ return s.replace(/-/g," ").replace(/\b\w/g,c=>c.toUpperCase()); }
function evoImgUrl(id){ return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`; }

function renderEvolution(paths){
  const container=document.getElementById("evoContent");
  container.innerHTML="";
  paths.forEach(path=>{
    const line=document.createElement("div"); line.className="evo-line";
    path.forEach((node, idx)=>{
      const nodeDiv=document.createElement("div");
      nodeDiv.className="evo-node";
      nodeDiv.innerHTML=`<img src="${evoImgUrl(node.id)}" alt="${node.name}"><div class="evo-name">${title(node.name)}</div>`;
      nodeDiv.onclick=()=>selectPokeById(node.id);
      line.append(nodeDiv);
      if(idx<path.length-1){
        const next=path[idx+1];
        const arrow=document.createElement("div"); arrow.className="evo-arrow"; arrow.textContent="‚Üí";
        const method=document.createElement("div"); method.className="evo-method"; method.textContent=formatMethod(next.details);
        const wrap=document.createElement("div"); wrap.style.display="flex"; wrap.style.flexDirection="column"; wrap.style.alignItems="center";
        wrap.append(arrow); wrap.append(method);
        line.append(wrap);
      }
    });
    container.append(line);
  });
}

/* Evo UI toggle */
const evoToggle=document.getElementById("evoToggleBtn");
let lastSelectedId=null;
evoToggle.onclick=async()=>{
  const card=document.getElementById("evoCard");
  if(card.hidden){
    if(!lastSelectedId){ alert("Pick a Pok√©mon first."); return; }
    await loadEvolutionForId(lastSelectedId);
    card.hidden=false; evoToggle.textContent="Hide Evolution Info";
  } else {
    card.hidden=true; evoToggle.textContent="Show Evolution Info";
  }
};
async function loadEvolutionForId(id){
  try{
    const species=await fetchSpeciesById(id);
    const evo=await fetchEvolutionChain(species.evolution_chain.url);
    const paths=buildPaths(evo.chain);
    renderEvolution(paths);
    document.getElementById("evoTitle").textContent=`Evolution ‚Äî ${title(species.name)}`;
  }catch(e){
    document.getElementById("evoContent").innerHTML="<em>Could not load evolution data.</em>";
  }
}

/* Select Pok√©mon */
async function selectPoke(p) {
  lastSelectedId = p.id;
  document.getElementById("evoCard").hidden = true;
  evoToggle.textContent = "Show Evolution Info";

  pokeList.innerHTML = "";
  pokeInput.value = p.name;
  document.getElementById("pokeTypes").innerHTML = "";

  // Hide pulsing Pok√© Ball placeholder and show Pok√©mon artwork
  const img = document.getElementById("pokeImg");
  img.classList.remove("pulse");
  img.classList.add("active");
  img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png`;

  // Display Pok√©mon type badges
  p.types.forEach(t => {
    const b = document.createElement("span");
    b.className = "type-badge";
    b.textContent = t;
    b.style.background = typeColors[t];
    document.getElementById("pokeTypes").append(b);
  });

  // Calculate and display defense info
  const def = calcDefense(p.types);
  renderDefenseOnly(document.getElementById("pokeResults"), p.name, def);

  // Sync Type tab and show both views
  t1.value = p.types[0];
  t2.value = p.types[1] || "";
  updateTypePreview();
  const label = p.types.join(" / ");
  const off = calcOffense(p.types);
  renderBoth(document.getElementById("typeResults"), label, def, off);
}

async function selectPokeById(id){
  await loadData();
  const found=pokedata.find(x=>x.id===id);
  if(found){ selectPoke(found); return; }
  const res=await fetch(`https://pokeapi.co/api/v2/pokemon/${id}/`);
  const j=await res.json();
  const types=j.types.map(t=>title(t.type.name));
  const name=title(j.name);
  selectPoke({id,name,types});
}

/* Pok√©mon reset */
document.getElementById("pokeResetBtn").onclick=()=>{
  pokeInput.value="";
  document.getElementById("pokeList").innerHTML="";
  document.getElementById("pokeTypes").innerHTML="";
  document.getElementById("pokeResults").innerHTML="";
  hidePokemonImage(); // <-- restore pulsing Pok√© Ball placeholder
  document.getElementById("evoCard").hidden=true;
  evoToggle.textContent="Show Evolution Info";
};

/* Type check button (again here to ensure binding) */
document.getElementById("checkBtn").onclick=()=>{
  const sel=[t1.value,t2.value].filter(Boolean);
  if(!sel.length) return;
  const label=sel.join(" / "); const def=calcDefense(sel), off=calcOffense(sel);
  renderBoth(document.getElementById("typeResults"),label,def,off);
};

/* PWA registration only over http(s) */
if("serviceWorker" in navigator && location.protocol.startsWith("http")){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
